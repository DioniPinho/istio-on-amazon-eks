:toc:
= Istio with Kubernetes on AWS

This repo shows how to get https://istio.io/docs/examples/bookinfo/[Istio BookInfo sample] running on a Kubernetes cluster on AWS. We'll use http://aws.amazon.com/eks[Amazon EKS] for the Kubernetes cluster. This is tested with https://github.com/istio/istio/releases/tag/1.0.2[Istio 1.0.2].

== Kubernetes Cluster on AWS

. Create Amazon EKS cluster using [eksctl](https://eksctl.io/):

	brew install weaveworks/tap/eksctl
	eksctl create cluster istio-eks --nodes 4

== Install and Configure Istio

. Download:

	curl -L https://github.com/istio/istio/releases/download/1.0.2/istio-1.0.2-osx.tar.gz | tar xzvf -
	cd istio-1.0.2
	export PATH=$PWD/bin:$PATH

. Install Helm:

	kubectl create -f install/kubernetes/helm/helm-service-account.yaml
	helm init --service-account tiller

. Install:

	helm install \
		--wait \
		--name istio \
		--namespace istio-system \
		install/kubernetes/helm/istio \
		--set tracing.enabled=true \
		--set grafana.enabled=true

. Verify services:

	kubectl get pods -n istio-system
	TODO

. Enable Istio on `default` namespace:

	kubectl label namespace default istio-injection=enabled

== BookInfo

=== Deploy BookInfo

Read details about https://istio.io/docs/guides/bookinfo/[BookInfo application].

. Deploy the application with automatic sidecar injection for each pod:

	kubectl apply -f samples/bookinfo/kube/bookinfo.yaml

. Verify services:

	kubectl get svc

. Verify pods:

	kubectl get pods

=== Define Ingress

. Define the ingress gateway for the application:

	kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml

. Confirm gateway:

	kubectl get gateway
	TODO

=== Access Application

. Define environment variables:

	export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
	export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http")].port}')
	export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].port}')
	export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT

. Access the application:

	open http://${GATEWAY_URL}/productpage

This will show the output:

image:images/bookinfo1.png[]

`reviews` service has 3 versions and so the output page will look diffeent with each refresh.

=== Apply default destination rules

. Define the destination rules:

	kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml

. Verify:

	kubectl get destinationrules -o yaml

== Intelligent Routing

This section demonstrates how to use various traffic management capabilities of an Istio service mesh.

=== Request Routing

=== Fault Injection

=== Traffic Shifting

Complete details at https://istio.io/docs/tasks/traffic-management/request-routing/.

. Set the default version of `reviews` service to v1:
+
	kubectl apply -f samples/bookinfo/routing/route-rule-all-v1.yaml
+
Multiple refereshes of the page now shows output from the same `reviews` service (no rating stars).
+
. Guide a specific user to `reviews:v2`:

	istioctl replace -f samples/bookinfo/routing/route-rule-reviews-test-v2.yaml

. Click on `Sign In` on top left, give `jason` as `User Name`, no password. The output page is refreshed:
+
image:images/bookinfo2.png[]
+
Click on `sign out`, `Sign In` again using `mike` and see the output:
+
image:images/bookinfo3.png[]
+
. Remove the rule:

	istioctl delete -f samples/bookinfo/routing/route-rule-all-v1.yaml

== Cleanup

. Delete routing rules and terminate application pods:

	samples/bookinfo/platform/kube/cleanup.sh

