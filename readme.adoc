:toc:
= Istio with Kubernetes on AWS

This repo shows how to get Istio BookInfo sample running on a Amazon EKS. This is tested with Istio 1.0.2.

== Kubernetes Cluster on AWS

Create Amazon EKS cluster using [eksctl](https://eksctl.io/):

	brew install weaveworks/tap/eksctl
	eksctl create cluster istio-eks --nodes 4

== Install and Configure Istio

. Install and configure:

	curl -L https://github.com/istio/istio/releases/download/1.0.2/istio-1.0.2-osx.tar.gz | tar xzvf -
	cd istio-1.0.2
	export PATH=$PWD/bin:$PATH
	kubectl apply -f install/kubernetes/istio-demo.yaml

. Verify:

	kubectl get pods -n istio-system
	NAME                                        READY     STATUS      RESTARTS   AGE
	grafana-cd99bf478-59qmx                     1/1       Running     0          4m
	istio-citadel-ff5696f6f-zkpzt               1/1       Running     0          4m
	istio-cleanup-old-ca-6nmrg                  0/1       Completed   0          4m
	istio-egressgateway-58d98d898c-bjd4f        1/1       Running     0          4m
	istio-ingressgateway-6bc7c7c4bc-sc7s6       1/1       Running     0          4m
	istio-mixer-post-install-g67rd              0/1       Completed   0          4m
	istio-pilot-6c5c6b586c-nfwt9                2/2       Running     0          4m
	istio-policy-5c7fbb4b9f-f2xtn               2/2       Running     0          4m
	istio-sidecar-injector-dbd67c88d-j8882      1/1       Running     0          4m
	istio-statsd-prom-bridge-6dbb7dcc7f-ms846   1/1       Running     0          4m
	istio-telemetry-54b5bf4847-nlqjx            2/2       Running     0          4m
	istio-tracing-67dbb5b89f-9zd5j              1/1       Running     0          4m
	prometheus-586d95b8d9-mz9bm                 1/1       Running     0          4m
	servicegraph-6d86dfc6cb-tbwwt               1/1       Running     0          4m

== Deploy BookInfo 

Read details about https://istio.io/docs/guides/bookinfo/[BookInfo application].

. Deploy the application with manual sidecar injection for each pod:

	kubectl apply -f <(istioctl kube-inject -f samples/bookinfo/kube/bookinfo.yaml)

. Define the ingress for each application:

	istioctl create -f samples/bookinfo/routing/bookinfo-gateway.yaml

. Define environment variables:

	export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
	export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http")].port}')
	export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].port}')
	export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT

. Access the application:

	open http://${GATEWAY_URL}/productpage
+
This will show the output:
+
image:images/bookinfo1.png[]
+
`reviews` service has 3 versions and so the output page will look diffeent with each refresh.

== Content-based Routing

Complete details at https://istio.io/docs/tasks/traffic-management/request-routing/.

. Set the default version of `reviews` service to v1:
+
	kubectl apply -f samples/bookinfo/routing/route-rule-all-v1.yaml
+
Multiple refereshes of the page now shows output from the same `reviews` service (no rating stars).
+
. Guide a specific user to `reviews:v2`:

	istioctl replace -f samples/bookinfo/routing/route-rule-reviews-test-v2.yaml

. Click on `Sign In` on top left, give `jason` as `User Name`, no password. The output page is refreshed:
+
image:images/bookinfo2.png[]
+
Click on `sign out`, `Sign In` again using `mike` and see the output:
+
image:images/bookinfo3.png[]
+
. Remove the rule:

	istioctl delete -f samples/bookinfo/routing/route-rule-all-v1.yaml

== Fault Injection

